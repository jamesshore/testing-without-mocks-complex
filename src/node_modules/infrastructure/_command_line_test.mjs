// Copyright Titanium I.T. LLC.
import assert from "util/assert.mjs";
import { CommandLine } from "infrastructure/command_line.mjs";
import { runModuleAsync } from "util/test_helper.mjs";
import { pathToFile } from "util/module_paths.mjs";
// dependency_analysis: ./_command_line_test_args_runner
// dependency_analysis: ./_command_line_test_null_output_runner
// dependency_analysis: ./_command_line_test_output_runner

describe("CommandLine", () => {

	it("provides command-line arguments", async () => {
		const args = [ "my arg 1", "my arg 2" ];
		const { stdout } = await runModuleAsync(
			pathToFile(import.meta.url, "_command_line_test_args_runner.mjs"),
			{ args },
		);
		assert.equal(stdout, '["my arg 1","my arg 2"]');
	});

	it("writes to stdout and stderr", async () => {
		const { stdout, stderr } = await runModuleAsync(
			pathToFile(import.meta.url, "_command_line_test_output_runner.mjs"),
			{ failOnStderr: false },
		);
		assert.equal(stdout, "my stdout", "stdout");
		assert.equal(stderr, "my stderr", "stderr");
	});

	it("tracks writes to stdout and stderr", () => {
		const commandLine = CommandLine.createNull();
		const stdout = commandLine.trackStdout();
		const stderr = commandLine.trackStderr();

		commandLine.writeStdout("my stdout");
		commandLine.writeStderr("my stderr");
		assert.deepEqual(stdout.data, [ "my stdout" ]);
		assert.deepEqual(stderr.data, [ "my stderr" ]);
	});


	describe("nulled instances", () => {

		it("defaults to no arguments", () => {
			const commandLine = CommandLine.createNull();
			assert.deepEqual(commandLine.args(), []);
		});

		it("allows arguments to be configured", () => {
			const commandLine = CommandLine.createNull({ args: [ "one", "two" ] });
			assert.deepEqual(commandLine.args(), [ "one", "two" ]);
		});

		it("doesn't write output to command line", async () => {
			const { stdout, stderr } = await runModuleAsync(
				pathToFile(import.meta.url, "_command_line_test_null_output_runner.mjs"),
				{ failOnStderr: false },
			);
			assert.equal(stdout, "", "stdout");
			assert.equal(stderr, "", "stderr");
		});

	});

});


